<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../responsive-table/responsive-table.html">
<link rel="import" href="../shared-styles.html">


<dom-module id="responsive-table">
    <template>
        <style>
            :host {
                display: block;
            }
            .table {
                font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
                border-collapse: collapse;
                width: 100%;
                display: table;
            }

            .td, .th {
                border: 1px solid #ddd;
                display: table-cell;
                padding-left: 5px;
                padding-right: 5px;
            }

            .tr{
                display: table-row;
            }

            .tr:nth-child(even){background-color: #f2f2f2;}

            .tr:hover {background-color: #ddd;}

            .th {
                padding-top: 12px;
                padding-bottom: 12px;
                text-align: left;
                background-color: rgba(0, 0, 0, 0.86);
                color: white;
            }

            #area-collapse .td{
                width: 100%;
            }

            .btn-collapse{
                border: 1px solid #fff;
                padding: 10px;
                background: darkgray;
            }

            .btn-collapse--delete{
                text-align: right;
            }

            #area-collapse  img {
                width: 30%;
            }

            #area-table  img{
                width: 100%;
            }

        </style>

        <div id="responsive-table">
            <div id="area-collapse">
                <dom-repeat items="[[collapseItems]]">
                    <template>
                        <div>
                            <div class="btn-collapse">
                                <div><a href="users/#collapse_[[index]]" on-click="toggle">&darr; [[item.title]]</a></div>
                                <div class="btn-collapse--delete">
                                    <template is="dom-if" if="[[deleteOption]]">
                                        <br>
                                        <a href="users/#collapse_[[index]]" on-click="_handleDelete">Eliminar</a>
                                    </template>
                                </div>
                            </div>
                            <iron-collapse id="collapse_[[index]]">
                                <div>
                                    <dom-repeat items="[[item.data]]" as="item2">
                                        <template>
                                            <div class="tr">
                                                <div class="th">[[item2.header]]</div>
                                                <template is="dom-if" if="[[_isString(item2.content.type)]]">
                                                    <div class="td">[[item2.content.content]]</div>
                                                </template>
                                                <template is="dom-if" if="[[_isImage(item2.content.type)]]">
                                                    <div class="td"><img src="[[item2.content.content]]"></div>
                                                </template>
                                            </div>
                                        </template>
                                    </dom-repeat>
                                </div>
                            </iron-collapse>
                        </div>
                    </template>
                </dom-repeat>
            </div>
            <div id="area-table">
                <div class="table">
                    <div class="tr">
                        <dom-repeat items="[[tableHeaders]]">
                            <template>
                                <div class="th">[[item]]</div>
                            </template>
                        </dom-repeat>
                    </div>

                    <dom-repeat id="tbody" items="[[tableBody]]">
                        <template>
                            <div class="tr" id="tbody-tr-[[index]]">
                                <dom-repeat items="[[item.cells]]">
                                    <template>
                                        <template is="dom-if" if="[[_isString(item.type)]]">
                                            <div class="td">[[item.content]]</div>
                                        </template>
                                        <template is="dom-if" if="[[_isImage(item.type)]]">
                                            <div class="td"><img src="[[item.content]]"></div>
                                        </template>
                                        <template is="dom-if" if="[[_isCollection(item.type)]]">
                                            <div class="td">
                                                <dom-repeat items="[[item.content]]" as="story">
                                                    <template>
                                                        [[story.name]]
                                                    </template>
                                                </dom-repeat>
                                            </div>
                                        </template>
                                    </template>
                                </dom-repeat>
                                <template is="dom-if" if="[[deleteOption]]">
                                    <div class="td"><a href="#tbody-tr-[[index]]" on-click="_handleDelete">Eliminar</a></div>
                                </template>
                            </div>
                        </template>
                    </dom-repeat>

                </div>
            </div>
        </div>
    </template>

    <script>
        class ResponsiveTable extends Polymer.mixinBehaviors(Polymer.IronResizableBehavior, Polymer.Element) {
            static get is() { return 'responsive-table'; }

            static get properties() {
                return {
                    headers: {
                        type: Object,
                        value: [],
                        reflectToAttribute: true,
                        observer: '_refreshTable'
                    },
                    rows: {
                        type: Object,
                        value: [],
                        reflectToAttribute: true,
                        observer: '_refreshTable'
                    },
                    collapseItems: {
                        type: Object,
                        computed: '_itemsVista1(vista)'
                    },
                    tableHeaders: {
                        type: Object,
                        computed: '_headers(vista)'
                    },
                    tableBody: {
                        type: Object,
                        computed: '_body(vista)'
                    },
                    vista: {
                        type: Number,
                        value: 1,
                        reflectToAttribute: true
                    },
                    deleteOption:{
                        type: Boolean,
                        value: false,
                        reflectToAttribute: true
                    }
                };
            }

            constructor(){
                super();
            }

            connectedCallback() {
                super.connectedCallback();
                this.addEventListener('iron-resize', this._handleResize);
                this.vista = this._vista();
            }

            _handleResize() {
                if(this.clientWidth < 680 && this.vista !== 1){
                    this.vista = 1;
                }else if(this.clientWidth >= 680 && this.vista !== 2){
                    this.vista = 2;
                }
            }

            _itemsVista1(vista){
                if(vista === 1){
                    const collapseItems = [];
                    console.log(this.rows);
                    for(const row of this.rows){
                        const element = {title:row.title, data:[]};
                        for(const cell of row.cells){
                            element.data.push({content:cell});
                        }
                        for(let i=0;i<this.headers.length;i++){
                            if(i<element.data.length){
                                element.data[i].header = this.headers[i];
                            }else{
                                element.data.push({header:this.headers[i]});
                            }
                        }
                        collapseItems.push(element);
                    }
                    return collapseItems;
                }
                return [];
            }

            _headers(vista){
                if(vista === 2){
                    return this.headers;
                }
                return [];
            }

            _body(vista){
                if(vista === 2){
                    return this.rows;
                }
                return [];
            }

            _vista(){
                if(this.clientWidth < 500){
                    return  1;
                }else if(this.clientWidth >= 500){
                    return 2;
                }
            }

            toggle(event){
                const index = event.model.index;
                const node = this.$['area-collapse'].querySelector('#collapse_' + index);
                node.toggle();
                event.target.setAttribute('aria-expanded',node.opened);
            }

            _refreshTable(){
                const vista = this.vista;
                this.vista = 0;
                this.vista = vista;
            }

            _isString(type){
                return type==='string';
            }
            _isImage(type){
                return type==='image';
            }
            _isCollection(type){
                return type==='collection';
            }

            _handleDelete(event){
                const index = event.model.index;
                this.dispatchEvent(new CustomEvent('delete-item', {
                    bubbles: true,
                    composed: true,
                    detail: {
                        index: index
                    }
                }));
            }
        }

        window.customElements.define(ResponsiveTable.is, ResponsiveTable);
    </script>
</dom-module>
