<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="shared-styles.html">

<dom-module id="labs-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px;
      }

      .list__labs{
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
      }

      paper-card{
        margin-top: 24px;
        margin-bottom: 24px;
      }

      paper-card.white{
        --paper-card-header-color: white;
      }
      .list__labs > paper-card{
        /*flex: 2 30%;*/
      }

      paper-input.white{
        margin: 0 10% 0 10%;
      }

      paper-card{
        --paper-card-header: {
          height: 50%;
          background: #222222;
        };
        width: 100%;
      }

      @media screen and (min-width: 930px) {
        paper-card{
          width: 30%;
        }
      }


    </style>
    <div class="banner">
      <paper-input id="input_lab" class="white" always-float-label label="Nombre del curso" on-keyup="_filter"></paper-input>
    </div>
    <div id="area-collapse" class="card list__labs">
      <template id="repeat" is="dom-repeat" items="[[labs]]">
        <template is="dom-if" if="[[_renderCard(item, filter)]]">
          <paper-card heading="[[item.category]]" image="[[item.image]]" alt="Sailboat Harbor" class="white">
            <div class="card-content">[[item.title]]</div>
            <div class="card-actions">
              <!--<paper-button>Compartir</paper-button>-->
              <paper-button on-click="_handleLab" lab-uid$="[[item.uid]]">Iniciar</paper-button>
              <paper-icon-button icon="my-icons:add" title="more info" on-click="_toggle" style="float:right;">
              </paper-icon-button>
              <iron-collapse id="collapse_[[index]]" style="width:100%;">
                [[item.description]]
              </iron-collapse>
            </div>
          </paper-card>
        </template>
      </template>

    </div>
  </template>

  <script>
    class LabsView extends Polymer.Element {
      static get is() { return 'labs-view'; }

      static get properties() {
          return {
              labs: {
                  type: Object,
                  value: []
              },
              isLogin: {
                type: Boolean
              },
              filter:{
                  type: String,
                  value: ''
              }
          };
      }

      connectedCallback() {
        super.connectedCallback();
        if(firebase) {
            const lavsRef = firebase.database().ref('labs/');
            lavsRef.on('value', (snapshot) => {
                const values = snapshot.val();
                if (values) {
                    const newLabs = [];
                    for (const item in values) {
                        newLabs.push(Object.assign({}, {uid: item}, values[item]));
                    }
                    newLabs.sort((a, b)=>{
                        return a.title.localeCompare(b.title);
                    });
                    this.labs = newLabs;
                }
            });
        }
      }

      _toggle(event){
          const index = event.model.index;
          const node = this.$['area-collapse'].querySelector('#collapse_' + index);
          node.toggle();
          event.target.setAttribute('aria-expanded',node.opened);
      }

      _launchSelectedLab(uidLab){
          this.dispatchEvent(new CustomEvent('selected-lab', {
              bubbles: true,
              composed: true,
              detail: {
                  uidLab
              }
          }));
      }

      _handleLab(event){
          const uidLab = event.target.getAttribute('lab-uid');
          if(this.isLogin){
              this._launchSelectedLab(uidLab);
          }else{
              this.dispatchEvent(new CustomEvent('required-login', {
                  bubbles: true,
                  composed: true,
                  detail: {
                      page: 'lab',
                      uidLab
                  }
              }));
          }
      }

      _renderCard(lab, filter){
          if(!filter || filter === ''){
              return true;
          }

          return lab.title.toString().startsWith(filter);
      }
      _filter(event){
          this.set('filter', this.$['input_lab'].value);
      }
    }

    window.customElements.define(LabsView.is, LabsView);
  </script>
</dom-module>
